{% extends "layout.html" %}

{% block title %}
Citation App
{% endblock %}

{% block content %}

<h1>Library search</h1>

<!-- Search form -->
<div style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px;">
    <!-- Material -->
    <label for="material_type" style="width: 60px;">Material:</label>
    <select id="material_type" name="material_type">
        <option value="">All</option>
        <option value="article">Article</option>
        <option value="book">Book</option>
        <option value="inproceeding">Inproceeding</option>
    </select>

    <!-- Keyword (search type) -->
    <label for="keyword" style="width: 60px;">Keyword:</label>
    <select id="keyword" name="keyword">
        <option value="">All</option>
        <option value="author">Author</option>
        <option value="title">Title</option>
    </select>

    <!-- Year range -->
    <label for="year" style="width: 30px;">Year:</label>
    <input type="number" id="minYear" name="minYear" style="width: 60px;" placeholder="From">
    <span>-</span>
    <input type="number" id="maxYear" name="maxYear" style="width: 60px;" placeholder="To">
</div>

<div style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px;">
    <!-- Search text -->
    <label for="search" style="width: 60px;">Search:</label>
    <input type="text" id="search" name="search" placeholder="Enter keyword" style="width: 200px;">

    <button type="button" id="filterBtn" style="margin-left: 10px;">Search</button>
</div>

<!-- Links -->
 <p></p>
<form action="/add_type" method="GET">
<label for="add_type">Add new:</label>
<select id="add_type" name="add_type">
  <option value="article">Article</option>
  <option value="book">Book</option>
  <option value="inproceeding">Inproceeding</option>
</select>
<input type="submit" value="Add"/>
</p>

</form>
<div style="margin-top: 10px;">
  <a href="{{ url_for('bib_view') }}">View bib in browser</a>
</div>
<div style="margin-top: 10px;">
  <a href="{{ url_for('bib_file') }}">Download a .bib file</a>
</div>
<div style="margin-top: 10px;">
  <a href="{{ url_for('test_source') }}">Generate a random source (testing)</a>
</div>

<!-- DOI citations -->
<form action="/cite_doi" method="post">
  <p>Add a citation with a DOI:</p>
  <label for="doi">*DOI:</label>
  <input type="text" placeholder="Enter DOI" name="doi" required>

  <label for="citekey">*Citekey:</label>
  <input type="text" placeholder="Enter citekey" name="citekey" required>

  <label for="tag">Tag:</label>
  <input type="text" placeholder="Enter tag" name="tag">

  <input type="submit" value="Add citation">
</form>

<!-- Flash messages -->
<div>
  {% with messages = get_flashed_messages() %}
    {% if messages %}
      <ul>
        {% for message in messages %}
          <li>{{ message }}</li>
        {% endfor %}
      </ul>
    {% endif %}
  {% endwith %}
</div>

<hr>

    <!-- Articles table -->
    <table id="articlesTable" border="1" cellpadding="5" cellspacing="0">
      <thead>
        <tr>
          {% for col, display_name in columns.items() %}
  <th>{{ display_name }}</th>
{% endfor %}
          <th>{{ empty }}</th>
        </tr>
      </thead>

      <tbody>
        {% for row in records %}
          <tr>

            {% for column in columns %}
              {% set value = row[column] %}

              {% if value %}

                {% if column == 'citekey' %}
                  <!-- Make citekey a hyperlink -->
                  <td>
                    <a href="{{ url_for('view_item', citekey=row['citekey']) }}">
                      {{ value }}
                    </a>
                  </td>

                {% elif column == 'name' %}
                  <!-- Make article name a hyperlink -->
                  <td>
                    <a href="{{ url_for('view_item', citekey=row['citekey']) }}">
                      {{ value }}
                    </a>
                  </td>

                {% else %}
                  <td>{{ value }}</td>

                {% endif %}

              {% else %}
                <td>{{ empty }}</td>
              {% endif %}

            {% endfor %}
            
            {% if row['citation_type'] == "article" %}
              <td><a href="{{ url_for('edit_article', citekey=row['citekey']) }}">Modify</a></td>
            {% elif row['citation_type'] == "book" %}
              <td><a href="{{ url_for('edit_book', citekey=row['citekey']) }}">Modify</a></td>
            {% elif row['citation_type'] == "inproceedings" %}
              <td><a href="{{ url_for('edit_inproceeding', citekey=row['citekey']) }}">Modify</a></td>
            {% endif %}

          </tr>
        {% endfor %}
      </tbody>
    </table>

<p>
  <a href="/{{ page - 1 }}">&lt;&lt;</a>
  Page {{ page }}/{{ page_count }}
  <a href="/{{ page + 1 }}">&gt;&gt;</a>
</p>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const filterBtn = document.getElementById('filterBtn');
  const table = document.getElementById('articlesTable');
  filterBtn.addEventListener('click', () => {
    const minYear = parseInt(document.getElementById('minYear').value) || 0;
    const maxYear = parseInt(document.getElementById('maxYear').value) || 9999;
    const search = (document.getElementById('search').value || "").toLowerCase();
    const searchType = document.getElementById('keyword').value;
    const materialType = document.getElementById('material_type').value;

    for (let row of table.tBodies[0].rows) {
      const cells = row.cells;
      const year = parseInt(cells[5].textContent) || 0;
      const author = (cells[2].textContent || "").toLowerCase();
      const name = (cells[3].textContent || "").toLowerCase();
      const material = (cells[1].textContent || "").toLowerCase();

      let show = (year >= minYear && year <= maxYear);

      if (materialType === "article") {
        show = show && material === "article";
      } else if (materialType === "book") {
        show = show && material === "book";
      } else if (materialType === "inproceeding") {
        show = show && material === "inproceeding";
      }

      if (search) {
        if (searchType === "author") {
          show = show && author.includes(search);
        } else if (searchType === "title") {
          show = show && name.includes(search);
        } else {
          // keyword = "All" â†’ haku molemmista
          show = show && (author.includes(search) || name.includes(search));
        }
      }

      row.style.display = show ? "" : "none";
    }
  });
});
</script>

{% endblock %}
