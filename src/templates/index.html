{% extends "layout.html" %}

{% block title %}
Citation App
{% endblock %}

{% block content %}

<h2>Library search</h2>

<style>
.academia {
    border-collapse: collapse;
    width: 100%;
    border-top: 2.27px solid black;
    border-bottom: 2.27px solid black;
    box-shadow: 0 0 20px rgba(0, 0, 0, 0.15);
}

.academia th,
.academia td {
    text-align: left;
    vertical-align: middle;
    padding: 0.51rem;
}

.academia thead th {
    background: none !important;
    border: none !important;
    border-bottom: 1.36px solid black !important;
    font-weight: 700;
}

.academia thead tr {
    border: none !important;
}

.academia tbody tr:first-child td {
    border-top: 1.36px solid black;
}

.academia tbody tr:last-child td {
    border-bottom: 1.36px solid black;
}

.academia tbody tr:nth-child(even) {
    background-color: #ebecf1;
}

.academia tbody tr:hover td {
    background-color: #f5f1da;
}
</style>


<!-- Search form -->
<div style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px;">
    <!-- Material -->
    <label for="material_type" style="width: 60px;">Material:</label>
    <select id="material_type" name="material_type">
        <option value="">All</option>
        <option value="article">Article</option>
        <option value="book">Book</option>
        <option value="inproceeding">Inproceeding</option>
    </select>

    <!-- Keyword (search type) -->
    <label for="keyword" style="width: 60px;">Keyword:</label>
    <select id="keyword" name="keyword">
        <option value="">All</option>
        <option value="author">Author</option>
        <option value="title">Title</option>
        <option value="tag">Tag</option>
    </select>

    <!-- Year range -->
    <label for="year" style="width: 30px;">Year:</label>
    <input type="number" id="minYear" name="minYear" style="width: 60px;" placeholder="From">
    <span>-</span>
    <input type="number" id="maxYear" name="maxYear" style="width: 60px;" placeholder="To">
</div>

<div style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px;">
    <!-- Search text -->
    <label for="search" style="width: 60px;">Search:</label>
    <input type="text" id="search" name="search" placeholder="Enter keyword" style="width: 200px;">

    <button type="button" value="Filter" id="filterBtn" style="margin-left: 10px;">Search</button>
</div>

<!-- Links -->
 <p></p>
<form action="/add_type" method="GET">
<label for="add_type">Add new:</label>
<select id="add_type" name="add_type">
  <option value="article">Article</option>
  <option value="book">Book</option>
  <option value="inproceeding">Inproceeding</option>
</select>
<input type="submit" value="Add"/>
</p>

<!-- ACM link citations -->
<form action="/cite_acm" method="post">
  <p>Add a citation with an ACM Digital Library link:</p>
  <label for="acm_url">*URL:</label>
  <input id="acm_url" type="text" placeholder="Enter URL" name="url" required>

  <label for="acm_citekey">*Citekey:</label>
  <input id="acm_citekey" type="text" placeholder="Enter citekey" name="citekey" required>

  <label for="acm_tag">Tag:</label>
  <input id="acm_tag" type="text" placeholder="Enter tag" name="tag">

  <label for="acm_add"></label>
  <input id="acm_add" type="submit" value="Add citation">
</form>

<!-- DOI citations -->
<form action="/cite_doi" method="post">
  <p>Add a citation with a DOI:</p>
  <label for="doi_doi">*DOI:</label>
  <input id="doi_doi" type="text" placeholder="Enter DOI" name="doi" required>

  <label for="doi_citekey">*Citekey:</label>
  <input id="doi_citekey" type="text" placeholder="Enter citekey" name="citekey" required>

  <label for="doi_tag">Tag:</label>
  <input id="doi_tag" type="text" placeholder="Enter tag" name="tag">

  <label for="doi_add"></label>
  <input id="doi_add" type="submit" value="Add citation">
</form>

<div style="margin-top: 10px;">
    <button type="button" onclick="window.location.href='{{ url_for('bib_view') }}'">
      View bib in browser
    </button>
  </div>
  
  <div style="margin-top: 10px;">
    <button type="button" onclick="window.location.href='{{ url_for('bib_file') }}'">
      Download a .bib file
    </button>
  </div>
  
<!-- Flash messages -->
<div>
  {% with messages = get_flashed_messages() %}
    {% if messages %}
      <ul>
        {% for message in messages %}
          <li>{{ message }}</li>
        {% endfor %}
      </ul>
    {% endif %}
  {% endwith %}
</div>

<hr>
<h3 id="noResults" style="display:none; font-weight: bold; margin-top:10px;">
    The search returned no results.
</h3>
<h3 id="resultCount" style="font-weight: bold; margin-top:10px; display: none;"></h3>
<h3 id="totalCount" style="font-weight: bold; margin-top:10px;"></h3>
<!-- Three-column source display -->
<table id="sourceTable" class="academia" border="1" cellpadding="5" cellspacing="0" style="width:100%; border-collapse: collapse;">
    <thead>
        <tr>
            <th>Type</th>
            <th>Title</th>
            <th>Author</th>
            <th>Year</th>
            <th>Tag</th>
            <th>Citekey</th>
            <th>PDF</th>
        </tr>
    </thead>
    <tbody>
        {% for row in records %}
        <tr class="source-item"
            data-type="{{ row['citation_type'] }}"
            data-title="{{ row['title'] or row['name'] }}"
            data-author="{{ row['author'] }}"
            data-year="{{ row['year'] }}"
            data-tag="{{ row['tag'] }}">
            <td>{{ row['citation_type'] }}</td>
            <td>
                <a href="{{ url_for('view_item', citekey=row['citekey']) }}">
                    {{ row['title'] or row['name'] }}
                </a>
            </td>
            <td>{{ row['author'] }}</td>
            <td>{{ row['year'] }}</td>
            <td>{{ row['tag'] }}</td>
            <td>{{ row['citekey'] }}</td>
            <td>
                {% if row['pdf'] %}
                    <a href="{{ url_for('serve_pdf', citekey=row['citekey']) }}" target="_blank">View file</a>
                {% endif %}
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<script>

// Näytetään sivun avattaessa kaikkien lähteiden määrä
window.addEventListener('DOMContentLoaded', () => {
    const rows = document.querySelectorAll("#sourceTable tbody .source-item");
    const totalCountElem = document.getElementById("totalCount");
    totalCountElem.textContent = `Total sources: ${rows.length}`;
});

document.getElementById("filterBtn").addEventListener("click", function () {
    const query = document.getElementById("search").value.toLowerCase();
    const keyword = document.getElementById("keyword").value;
    const material = document.getElementById("material_type").value;
    const minYear = parseInt(document.getElementById("minYear").value) || null;
    const maxYear = parseInt(document.getElementById("maxYear").value) || null;

    const rows = document.querySelectorAll("#sourceTable tbody .source-item");
    let visibleCount = 0;

    const table = document.getElementById("sourceTable");
    const noResults = document.getElementById("noResults");
    const resultCount = document.getElementById("resultCount");
    const totalCountElem = document.getElementById("totalCount");

    // __Aluksi piilotetaan kaikki muut viestit__
    noResults.style.display = 'none';
    resultCount.style.display = 'none';
    totalCountElem.style.display = 'none';  // Piilotetaan totalCount haun alkaessa

    rows.forEach(row => {
        let textToSearch = '';
        if (keyword === 'author') textToSearch = row.dataset.author;
        else if (keyword === 'title') textToSearch = row.dataset.title;
        else if (keyword === 'tag') textToSearch = row.dataset.tag;
        else textToSearch = [row.dataset.title, row.dataset.author, row.dataset.tag].join(' ');

        const matchesQuery = textToSearch.toLowerCase().includes(query);

        let matchesYear = true;
        const year = parseInt(row.dataset.year);
        if (minYear !== null) matchesYear = matchesYear && year >= minYear;
        if (maxYear !== null) matchesYear = matchesYear && year <= maxYear;

        let matchesMaterial = true;
        if (material) matchesMaterial = row.dataset.type === material;

        if (matchesQuery && matchesYear && matchesMaterial) {
            row.style.display = '';
            visibleCount++;
        } else {
            row.style.display = 'none';
        }
    });

    if (visibleCount === 0) {
        noResults.style.display = 'block';
        table.style.display = 'none';
    } else {
        noResults.style.display = 'none';
        table.style.display = 'table';
        resultCount.style.display = 'block';
        resultCount.textContent = `The search returned ${visibleCount} result${visibleCount > 1 ? 's' : ''}.`;
    }
});



</script>


{% endblock %}
