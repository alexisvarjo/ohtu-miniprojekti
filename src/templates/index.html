{% extends "layout.html" %}

{% block title %}
Citation App
{% endblock %}

{% block content %}

<h1>Library search</h1>

<!-- Search form -->
<div style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px;">
    <!-- Material -->
    <label for="material_type" style="width: 60px;">Material:</label>
    <select id="material_type" name="material_type">
        <option value="">All</option>
        <option value="article">Article</option>
        <option value="book">Book</option>
        <option value="inproceeding">Inproceeding</option>
    </select>

    <!-- Keyword (search type) -->
    <label for="keyword" style="width: 60px;">Keyword:</label>
    <select id="keyword" name="keyword">
        <option value="">All</option>
        <option value="author">Author</option>
        <option value="title">Title</option>
        <option value="title">Tag</option>
    </select>

    <!-- Year range -->
    <label for="year" style="width: 30px;">Year:</label>
    <input type="number" id="minYear" name="minYear" style="width: 60px;" placeholder="From">
    <span>-</span>
    <input type="number" id="maxYear" name="maxYear" style="width: 60px;" placeholder="To">
</div>

<div style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px;">
    <!-- Search text -->
    <label for="search" style="width: 60px;">Search:</label>
    <input type="text" id="search" name="search" placeholder="Enter keyword" style="width: 200px;">

    <button type="button" id="filterBtn" style="margin-left: 10px;">Search</button>
</div>

<!-- Links -->
 <p></p>
<form action="/add_type" method="GET">
<label for="add_type">Add new:</label>
<select id="add_type" name="add_type">
  <option value="article">Article</option>
  <option value="book">Book</option>
  <option value="inproceeding">Inproceeding</option>
</select>
<input type="submit" value="Add"/>
</p>

</form>
<div style="margin-top: 10px;">
  <a href="{{ url_for('bib_view') }}">View bib in browser</a>
</div>
<div style="margin-top: 10px;">
  <a href="{{ url_for('bib_file') }}">Download a .bib file</a>
</div>
<div style="margin-top: 10px;">
  <a href="{{ url_for('test_source') }}">Generate a random source (testing)</a>
</div>

<!-- ACM link citations -->
<form action="/cite_acm" method="post">
  <p>Add a citation with an ACM Digital Library link (the information is fetched using the DOI):</p>
  <label for="acm_url">*URL:</label>
  <input id="acm_url" type="text" placeholder="Enter URL" name="url" required>

  <label for="acm_citekey">*Citekey:</label>
  <input id="acm_citekey" type="text" placeholder="Enter citekey" name="citekey" required>

  <label for="acm_tag">Tag:</label>
  <input id="acm_tag" type="text" placeholder="Enter tag" name="tag">

  <label for="acm_add"></label>
  <input id="acm_add" type="submit" value="Add citation">
</form>

<!-- DOI citations -->
<form action="/cite_doi" method="post">
  <p>Add a citation with a DOI:</p>
  <label for="doi_doi">*DOI:</label>
  <input id="doi_doi" type="text" placeholder="Enter DOI" name="doi" required>

  <label for="doi_citekey">*Citekey:</label>
  <input id="doi_citekey" type="text" placeholder="Enter citekey" name="citekey" required>

  <label for="doi_tag">Tag:</label>
  <input id="doi_tag" type="text" placeholder="Enter tag" name="tag">

  <label for="doi_add"></label>
  <input id="doi_add" type="submit" value="Add citation">
</form>

<!-- Flash messages -->
<div>
  {% with messages = get_flashed_messages() %}
    {% if messages %}
      <ul>
        {% for message in messages %}
          <li>{{ message }}</li>
        {% endfor %}
      </ul>
    {% endif %}
  {% endwith %}
</div>

<hr>
<!-- Three-column source display -->
<div class="columns-container">

  <!-- ARTICLES COLUMN -->
  <div class="column">
      <h2>Articles</h2>

      {% for row in records if row['citation_type'] == 'article' %}
      <div class="source-item">
          <a href="{{ url_for('view_item', citekey=row['citekey']) }}">
              {{ row['title'] or row['name'] }}
          </a>
          <div>Citekey: {{ row['citekey'] }}</div>
          <div>Author: {{ row['author'] }}</div>
          <div>Year: {{ row['year'] }}</div>
          <div>Tag: {{ row['tag'] }}</div>

          <a class="modify-link" href="{{ url_for('edit_article', citekey=row['citekey']) }}">
              Modify
          </a>
      </div>
      {% endfor %}
  </div>


  <!-- BOOKS COLUMN -->
  <div class="column">
      <h2>Books</h2>

      {% for row in records if row['citation_type'] == 'book' %}
      <div class="source-item">
          <a href="{{ url_for('view_item', citekey=row['citekey']) }}">
              {{ row['title'] or row['name'] }}
          </a>
          <div>Citekey: {{ row['citekey'] }}</div>
          <div>Author: {{ row['author'] }}</div>
          <div>Year: {{ row['year'] }}</div>
          <div>Tag: {{ row['tag'] }}</div>

          <a class="modify-link" href="{{ url_for('edit_book', citekey=row['citekey']) }}">
              Modify
          </a>
      </div>
      {% endfor %}
  </div>


  <!-- INPROCEEDINGS COLUMN -->
  <div class="column">
      <h2>Inproceedings</h2>

      {% for row in records if row['citation_type'] == 'inproceedings' %}
      <div class="source-item">
          <a href="{{ url_for('view_item', citekey=row['citekey']) }}">
              {{ row['title'] or row['name'] }}
          </a>
          <div>Citekey: {{ row['citekey'] }}</div>
          <div>Author: {{ row['author'] }}</div>
          <div>Year: {{ row['year'] }}</div>
          <div>Tag: {{ row['tag'] }}</div>

          <a class="modify-link" href="{{ url_for('edit_inproceeding', citekey=row['citekey']) }}">
              Modify
          </a>
      </div>
      {% endfor %}
  </div>

</div>

<p>
  <a href="/{{ page - 1 }}">&lt;&lt;</a>
  Page {{ page }}/{{ page_count }}
  <a href="/{{ page + 1 }}">&gt;&gt;</a>
</p>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const filterBtn = document.getElementById('filterBtn');
  const table = document.getElementById('articlesTable');
  filterBtn.addEventListener('click', () => {
    const minYear = parseInt(document.getElementById('minYear').value) || 0;
    const maxYear = parseInt(document.getElementById('maxYear').value) || 9999;
    const search = (document.getElementById('search').value || "").toLowerCase();
    const searchType = document.getElementById('keyword').value;
    const materialType = document.getElementById('material_type').value;

    for (let row of table.tBodies[0].rows) {
      const cells = row.cells;
      const year = parseInt(cells[5].textContent) || 0;
      const author = (cells[2].textContent || "").toLowerCase();
      const name = (cells[3].textContent || "").toLowerCase();
      const material = (cells[1].textContent || "").toLowerCase();
      const tag = (cells[7].textContent || "").toLowerCase();


      let show = (year >= minYear && year <= maxYear);

      if (materialType === "article") {
        show = show && material === "article";
      } else if (materialType === "book") {
        show = show && material === "book";
      } else if (materialType === "inproceeding") {
        show = show && material === "inproceeding";
      }

      if (search) {
        if (searchType === "author") {
          show = show && author.includes(search);
        } else if (searchType === "title") {
          show = show && name.includes(search);
        } else if (searchType === "tag") {
          show = show && tag.includes(search);
        } else {
          // keyword = "All" â†’ haku molemmista
          show = show && (author.includes(search) || name.includes(search));
        }
      }

      row.style.display = show ? "" : "none";
    }
  });
});
</script>

{% endblock %}
