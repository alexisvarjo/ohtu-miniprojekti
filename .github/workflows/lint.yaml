name: Lint (pylint)

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]

jobs:
  pylint:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Set up Python 3.12
        uses: actions/setup-python@v6
        with:
          python-version: '3.12'

      - name: Install Poetry
        run: pip install poetry

      - name: Cache Poetry virtualenvs
        uses: actions/cache@v4
        with:
          path: ~/.cache/pypoetry/virtualenvs
          key: venv-${{ runner.os }}-${{ hashFiles('**/poetry.lock') }}
          restore-keys: |
            venv-${{ runner.os }}-

      - name: Cache Poetry package downloads
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: pip-${{ runner.os }}-${{ hashFiles('**/poetry.lock') }}
          restore-keys: |
            pip-${{ runner.os }}-

      - name: Install dependencies (including dev)
        run: poetry install --with dev

      - name: Run pylint
        run: poetry run pylint src --exit-zero --score=y --output-format=text > pylint_report.txt

      - name: Upload pylint report artifact
        uses: actions/upload-artifact@v4
        with:
          name: pylint-report
          path: pylint_report.txt

      - name: Extract pylint score
        id: score
        working-directory: ${{ github.workspace }}
        run: |
          mkdir -p badge
          SCORE=$(grep -oP 'Your code has been rated at \K[0-9.]+(?=/10)' pylint_report.txt || echo "0")
          echo "score=$SCORE" >> $GITHUB_OUTPUT
          echo "{ \"schemaVersion\": 1, \"label\": \"pylint\", \"message\": \"${SCORE}/10\", \"color\": \"blue\" }" > badge/pylint_badge.json

      - name: Publish pylint badge to gh-pages
        if: github.event_name == 'push'
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_branch: gh-pages
          publish_dir: ${{ github.workspace }}/badge
          keep_files: true
          allow_empty_commit: false


        continue-on-error: true
