name: Lint (pylint)

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]

jobs:
  pylint:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Set up Python 3.12
        uses: actions/setup-python@v6
        with:
          python-version: '3.12'

      - name: Install Poetry
        run: pip install poetry

      - name: Cache Poetry virtualenvs
        uses: actions/cache@v4
        with:
          path: ~/.cache/pypoetry/virtualenvs
          key: venv-${{ runner.os }}-${{ hashFiles('**/poetry.lock') }}
          restore-keys: |
            venv-${{ runner.os }}-

      - name: Cache Poetry package downloads
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: pip-${{ runner.os }}-${{ hashFiles('**/poetry.lock') }}
          restore-keys: |
            pip-${{ runner.os }}-

      - name: Install dependencies (including dev)
        run: poetry install --with dev

      - name: Run pylint and enforce score >= 9.5
        run: |
          set -euo pipefail

          echo "Running pylint (forcing exit code 0 regardless of messages)..."
          # --exit-zero is CRITICAL: prevents pylint from failing the step directly
          poetry run pylint src --exit-zero --score=y --output-format=text | tee pylint_report.txt

          echo "Parsing pylint score from output..."
          python - << 'EOF'
          import re
          import sys
          from pathlib import Path

          text = Path("pylint_report.txt").read_text(encoding="utf-8", errors="ignore")

          # Standard pylint summary line, e.g.:
          # "Your code has been rated at 9.51/10"
          m = re.search(r"Your code has been rated at ([0-9.]+)/10", text)
          if not m:
              print("ERROR: Could not find pylint score in output. Full output follows:")
              print("=" * 80)
              print(text)
              print("=" * 80)
              sys.exit(1)

          score = float(m.group(1))
          print(f"Detected pylint score: {score}/10")

          threshold = 9.5
          if score < threshold:
              print(f"FAIL: pylint score {score} is below required threshold {threshold}.")
              sys.exit(1)

          print(f"PASS: pylint score {score} meets or exceeds threshold {threshold}.")
          EOF
